<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IOTA Wallet Publisher</title>
  <script src="https://cdn.jsdelivr.net/npm/@iota/sdk/web.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; max-width: 700px; }
    label { font-weight: bold; }
    input, textarea { width: 100%; margin-bottom: 20px; padding: 8px; }
    button { padding: 10px 20px; font-size: 16px; }
    #qr, #walletQR { margin-top: 20px; }
    a { word-break: break-word; }
    #status, #wallet { margin-top: 20px; font-weight: bold; white-space: pre-wrap; }
    #debug { margin-top: 30px; background: #f4f4f4; padding: 15px; border: 1px solid #ccc; font-family: monospace; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>IOTA Wallet Publisher (Rebased Testnet)</h2>

  <div id="wallet"></div>
  <canvas id="walletQR"></canvas>

  <form id="iotaForm">
    <label for="tag">Tag:</label>
    <input type="text" id="tag" name="tag" required />

    <label for="data">Data:</label>
    <textarea id="data" name="data" rows="4" required></textarea>

    <button type="submit">Send Tagged Data</button>
  </form>

  <div id="status"></div>
  <canvas id="qr"></canvas>

  <h3>üîç Debug Payload</h3>
  <div id="debug">(waiting for submission...)</div>

  <script type="module">
    import { Client, Utils } from "https://cdn.jsdelivr.net/npm/@iota/sdk/web.js";

    const nodeUrl = "https://api.testnet.iotaledger.net";
    const faucetUrl = "https://faucet.testnet.iotaledger.net";
    const explorerBase = "https://explorer.iotaledger.net/testnet/block/";

    const client = new Client({ nodes: [nodeUrl] });

    // Generate wallet
    const mnemonic = Utils.generateMnemonic();
    const secretManager = { mnemonic };
    const addresses = await client.generateAddresses(secretManager, {
      range: { start: 0, end: 1 },
      bech32Hrp: "atoi"
    });
    const walletAddress = addresses[0];

    // Display wallet info
    document.getElementById("wallet").innerHTML = `
üîê Wallet Address:
<code>${walletAddress}</code>

üíß Request free test IOTAs:
üîó <a href="${faucetUrl}?address=${walletAddress}" target="_blank">${faucetUrl}?address=${walletAddress}</a>
    `;
    QRCode.toCanvas(document.getElementById("walletQR"), walletAddress);

    // Form submission
    document.getElementById("iotaForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const tag = document.getElementById("tag").value.trim();
      const data = document.getElementById("data").value.trim();
      const timestamp = new Date().toISOString();
      const payload = `${data}\n\n[timestamp: ${timestamp}]`;

      if (!tag || !data) {
        document.getElementById("status").innerText = "‚ùå Tag and data fields must not be empty.";
        return;
      }

      try {
        const tips = await client.getTips();
        const block = await client.buildBlock({
          parentBlockIds: tips,
          payload: {
            type: 2,
            tag: Utils.toHex(tag),
            data: Utils.toHex(payload)
          }
        });

        const blockId = await client.postBlock(block);
        const explorerUrl = explorerBase + blockId;

        document.getElementById("status").innerHTML = `
‚úÖ Block sent successfully!
üîó <a href="${explorerUrl}" target="_blank">${explorerUrl}</a>
        `;
        document.getElementById("debug").textContent = JSON.stringify(block, null, 2);
        QRCode.toCanvas(document.getElementById("qr"), explorerUrl);
      } catch (err) {
        console.error("Error:", err);
        document.getElementById("status").innerText = `‚ùå Failed to send block:\n${err.message}`;
      }
    });
  </script>
</body>
</html>
